<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DTR Telemetry â€“ Performance Analytics</title>
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/telemetry.css">
  <link rel="stylesheet" href="css/theme.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Get the saved theme immediately to prevent a white "flash" on load
    const savedTheme = localStorage.getItem('user-theme') || 'f1';
    document.documentElement.setAttribute('data-theme', savedTheme);
  </script>
</head>
<body>

<div class="container telemetry-page">
  <!-- Header: compact single row -->
  <header class="telemetry-header card">
    <div class="telemetry-header-inner">
      <h1>Productivity Telemetry</h1>
      <div class="telemetry-header-actions">
        <label for="weekSelect" class="telemetry-label">Window</label>
        <select id="weekSelect" class="telemetry-select" onchange="updateView()">
          <option value="all">Full OJT Span</option>
        </select>
        <button class="telemetry-btn btn-theme-f1" onclick="setTelemetryTheme('f1')">F1</button>
        <button class="telemetry-btn btn-theme-cadillac" onclick="setTelemetryTheme('cadillac')">Cadillac</button>
        <button class="telemetry-btn btn-theme-apx" onclick="setTelemetryTheme('apx')">APX GP</button>
        <span class="export-divider">|</span>
        <button class="telemetry-btn btn-theme-kiki" onclick="setTelemetryTheme('kiki')">Kiki</button>
        <button class="telemetry-btn" onclick="window.location.href='index.html'">Back to DTR</button>
      </div>
    </div>
  </header>
  
  <!-- Section: Simulation Controls (Hidden by default or compact) -->
  <section class="telemetry-section simulation-box" id="simSection">
    <div class="card sim-card">
      <div class="sim-header">
        <h3><span class="sim-icon">âš¡</span> Performance Simulator</h3>
        <div class="sim-actions">
           <button class="telemetry-btn btn-dim" onclick="toggleSimulation()" id="simToggleBtn">Enter Sim Mode</button>
           <button class="telemetry-btn btn-danger" onclick="resetTelemetry()" style="display:none" id="simResetBtn">Reset Data</button>
        </div>
      </div>
      <div id="simControls" class="sim-body" style="display:none">
        <div class="sim-row">
          <div class="sim-input-group">
            <label>Daily Hours:</label>
            <input type="number" id="simHours" value="8" step="0.5" min="0" max="24">
          </div>
          <div class="sim-input-group">
            <label>Days to Add:</label>
            <input type="number" id="simDays" value="5" min="1" max="30">
          </div>
          <button class="telemetry-btn btn-accent" onclick="runSimulation()">Inject Sim Data</button>
        </div>
        <p class="sim-note">Note: Simulated data is temporary and won't affect your real DTR records unless synced.</p>
      </div>
    </div>
  </section>

  <!-- Section: Key metrics (2 rows Ã— 3 cols) -->
  <section class="telemetry-section">
    <h2 class="section-title">Overview</h2>
    <div class="telemetry-stats-grid">
      <div class="card stat-card" id="forecastCard">
        <h3>OJT Forecast</h3>
        <div class="stat-rows">
          <div class="stat-row"><span>Total Rendered</span><strong id="totalRenderedText">0h</strong></div>
          <div class="stat-row"><span>Remaining</span><strong id="remainingHoursText" class="stat-accent">0h</strong></div>
          <div class="stat-row"><span>Status</span><span id="timeDeficitText">...</span></div>
          <div class="stat-row"><span>Projected</span><strong id="completionDateText">TBD</strong></div>
        </div>
        <small id="avgPaceNote" class="stat-note">Based on current pace</small>
      </div>
      <div class="card stat-card" id="paceCalculatorCard">
        <h3>Required Pace</h3>
        <div class="stat-rows">
          <div class="stat-row"><span>Remaining</span><span id="remHoursPace" class="stat-accent">0h</span></div>
          <div class="stat-row"><span>Workdays left</span><span id="remDaysPace">0</span></div>
          <div class="stat-row"><span>Last 7d avg</span><span id="last7DayPace">0.0h/day</span></div>
        </div>
        <div class="pace-slider-wrap">
          <label style="display:flex; justify-content:space-between; align-items:center;">
            <span>Projected Target</span>
            <div style="display:flex; align-items:center; gap:8px;">
              <span><span id="paceSliderVal">8.0</span>h/day</span>
              <button class="telemetry-btn" id="resetPaceBtn" onclick="resetPaceSlider()" style="padding: 2px 6px; font-size: 10px; height: auto;">Reset</button>
            </div>
          </label>
          <input type="range" id="paceSlider" min="1" max="16" step="0.5" value="8" oninput="updateTargetPace(this.value)">
        </div>
        <p id="paceStatusMsg" class="stat-msg">Calculatingâ€¦</p>
      </div>
      <div class="card stat-card" id="efficiencyCard">
        <h3>Efficiency</h3>
        <div class="stat-rows">
          <div class="stat-row"><span>Time (Act/Plan)</span><span id="timeEffValue">0%</span></div>
          <div class="stat-row"><span>Energy (Blocks/Hr)</span><span id="energyEffValue">0%</span></div>
        </div>
      </div>
      <div class="card stat-card" id="recoveryCard">
        <h3>Recovery & Fatigue</h3>
        <div class="stat-status">
          <span id="fatigueIndicator" class="stat-emoji">ðŸŸ¢</span>
          <span id="fatigueLabel" class="stat-status-label">Stable</span>
        </div>
        <small id="fatigueNote" class="stat-note">Sustainability</small>
      </div>
      <div class="card stat-card" id="cogLoadCard">
        <h3>Cognitive Load</h3>
        <div class="stat-status">
          <span id="cogIndicator" class="stat-emoji">ðŸ”‹</span>
          <span id="cogLabel" class="stat-status-label">Normal</span>
        </div>
        <small id="cogNote" class="stat-note">OJT + Personal</small>
      </div>
      <div class="card stat-card" id="momentumCard">
        <h3>Momentum</h3>
        <div class="stat-rows">
          <div class="stat-row"><span>Index</span><span id="momentumValue">0%</span></div>
          <div class="stat-row"><span>Streak (â‰¥8h)</span><span id="streakValue">0 days</span></div>
        </div>
        <p id="momentumStatus" class="stat-msg">Stability</p>
      </div>
    </div>
  </section>

  <!-- Main chart: trajectory -->
  <section class="telemetry-section">
    <h2 class="section-title">Cumulative Progress vs Goal</h2>
    <div class="card chart-card chart-card-wide">
      <div class="chart-wrap chart-tall">
        <canvas id="trajectoryChart"></canvas>
      </div>
    </div>
  </section>

  <!-- Daily performance: delta + hour distribution + radar -->
  <section class="telemetry-section">
    <h2 class="section-title">Day-of-Week Dynamics</h2>
    <div class="telemetry-charts-row telemetry-charts-three">
      <div class="card chart-card">
        <h3>Session Delta (vs 8h)</h3>
        <div class="chart-wrap">
          <canvas id="deltaChart"></canvas>
        </div>
      </div>
      <div class="card chart-card">
        <h3>Day-of-Week Velocity</h3>
        <div class="chart-wrap">
          <canvas id="dayVelocityRadar"></canvas>
        </div>
      </div>
      <div class="card chart-card">
        <h3>Hours Distribution</h3>
        <div class="chart-wrap">
          <canvas id="hourDistChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Weekly trend (Refactored to Candlestick) -->
  <section class="telemetry-section">
    <div class="section-header-flex">
      <h2 class="section-title" style="border:none; margin:0;">Weekly Delta Momentum</h2>
      <div class="ohlc-legend">
        <div class="legend-item"><div class="level-box" style="background:var(--color-good)"></div> <span>Gained</span></div>
        <div class="legend-item"><div class="level-box" style="background:var(--accent)"></div> <span>Lost</span></div>
      </div>
    </div>
    <div class="card chart-card chart-card-wide">
      <div class="chart-wrap">
        <canvas id="candlestickChart"></canvas>
      </div>
    </div>
  </section>

  <!-- L2 & wellness -->
  <section class="telemetry-section">
    <h2 class="section-title">L2 Telemetry & Wellness</h2>
    <div class="telemetry-charts-row telemetry-charts-three">
      <div class="card stat-card">
        <h3>L2 Performance</h3>
        <div class="stat-rows">
          <div class="stat-row"><span>Focus Score</span><span id="focusScore" class="stat-accent">0.0</span></div>
          <div class="stat-row"><span>Commute use</span><span id="commuteEff">0%</span></div>
          <div class="stat-row"><span>Deep work</span><span id="deepWorkScore">0.0</span></div>
          <div class="stat-row"><span>Avg sleep</span><span id="avgSleep">0.0h</span></div>
          <div class="stat-row"><span>Avg recovery</span><span id="avgRecovery">0.0h</span></div>
          <div class="stat-row"><span>Avg identity</span><span id="avgIdentity">0.0 / 5</span></div>
          <div class="stat-row"><span>Personal/OJT</span><span id="personalOjtRatio">0%</span></div>
        </div>
      </div>
      <div class="card chart-card">
        <h3>Identity Alignment</h3>
        <div class="chart-wrap">
          <canvas id="identityChart"></canvas>
        </div>
      </div>
      <div class="card chart-card">
        <h3>Energy Zones</h3>
        <div class="chart-wrap">
          <canvas id="energyZoneChart"></canvas>
        </div>
      </div>
    </div>
  </section>


  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-spinner"></div>
    <p>Syncing telemetryâ€¦</p>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="scripts/dtr-core.js"></script>
<script src="scripts/dtr-image-store.js"></script>
<script src="scripts/telemetry-core.js"></script>
<script src="scripts/telemetry-charts.js"></script>
<script src="scripts/telemetry-sim.js"></script>
<script src="scripts/telemetry.js"></script>
</body>
</html>
